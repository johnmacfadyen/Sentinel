// Based on https://github.com/Azure/Azure-Sentinel/blob/master/Parsers/NGINX/NGINXHTTPServer.txt
// Modified to use Nginx Proxy Manager log format.
// Usage Instruction :
// Paste below query in log analytics, click on Save button and select as Function from drop down by specifying function name and alias as NGINXHTTPServer.
// Function usually takes 10-15 minutes to activate. You can then use function alias from any other queries (e.g. NGINXHTTPServer | take 10).
// Reference : Using functions in Azure monitor log queries : https://docs.microsoft.com/azure/azure-monitor/log-query/functions

let nginx_accesslog_events =() {
NGINX_CL
| where RawData matches regex @'(\[[^\]]*]) - ([0-9]+) ([0-9]+) - ([a-zA-Z]+) ([a-zA-Z]+) ([a-zA-Z]+(\.[a-zA-Z]+)+) "([^"]*)" \[Client (\b(?:(?:2(?:[0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9])\.){3}(?:(?:2([0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9]))\b)] \[Length ([0-9]+)] \[Gzip -] \[Sent-to (([0-9+(\.[0-9]+)+)] "([^"]*)" "([^"]*)"'
| extend EventProduct = 'NGINX Proxy Manager'
| extend EventType = 'AccessLog'
| extend SrcIpAddr = extract(@'(\[[^\]]*]) - ([0-9]+) ([0-9]+) - ([a-zA-Z]+) ([a-zA-Z]+) ([a-zA-Z]+(\.[a-zA-Z]+)+) "([^"]*)" \[Client (\b(?:(?:2(?:[0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9])\.){3}(?:(?:2([0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9]))\b)] \[Length ([0-9]+)] \[Gzip -] \[Sent-to (([0-9+(\.[0-9]+)+)] "([^"]*)" "([^"]*)"', 9, RawData)
| extend EventStartTime = todatetime(replace(@'\/', @'-', replace(@'(\d{2}\/\w{3}\/\d{4}):(\d{2}\:\d{2}\:\d{2})', @'\1 \2', extract(@'\[(.*?)\+\d+\]', 1, RawData))))
| extend HttpRequestMethod = extract(@'(\[[^\]]*]) - ([0-9]+) ([0-9]+) - ([a-zA-Z]+) ([a-zA-Z]+) ([a-zA-Z]+(\.[a-zA-Z]+)+) "([^"]*)" \[Client (\b(?:(?:2(?:[0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9])\.){3}(?:(?:2([0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9]))\b)] \[Length ([0-9]+)] \[Gzip -] \[Sent-to (([0-9+(\.[0-9]+)+)] "([^"]*)" "([^"]*)"', 4, RawData)
| extend Host = extract(@'(\[[^\]]*]) - ([0-9]+) ([0-9]+) - ([a-zA-Z]+) ([a-zA-Z]+) ([a-zA-Z]+(\.[a-zA-Z]+)+) "([^"]*)" \[Client (\b(?:(?:2(?:[0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9])\.){3}(?:(?:2([0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9]))\b)] \[Length ([0-9]+)] \[Gzip -] \[Sent-to (([0-9+(\.[0-9]+)+)] "([^"]*)" "([^"]*)"', 6, RawData)
| extend UrlOriginal = extract(@'(\[[^\]]*]) - ([0-9]+) ([0-9]+) - ([a-zA-Z]+) ([a-zA-Z]+) ([a-zA-Z]+(\.[a-zA-Z]+)+) "([^"]*)" \[Client (\b(?:(?:2(?:[0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9])\.){3}(?:(?:2([0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9]))\b)] \[Length ([0-9]+)] \[Gzip -] \[Sent-to (([0-9+(\.[0-9]+)+)] "([^"]*)" "([^"]*)"', 8, RawData)
| extend Upstream = extract(@'(\[[^\]]*]) - ([0-9]+) ([0-9]+) - ([a-zA-Z]+) ([a-zA-Z]+) ([a-zA-Z]+(\.[a-zA-Z]+)+) "([^"]*)" \[Client (\b(?:(?:2(?:[0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9])\.){3}(?:(?:2([0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9]))\b)] \[Length ([0-9]+)] \[Gzip -] \[Sent-to (([0-9+(\.[0-9]+)+)] "([^"]*)" "([^"]*)"', 13, RawData)
| extend Scheme = extract(@'(\[[^\]]*]) - ([0-9]+) ([0-9]+) - ([a-zA-Z]+) ([a-zA-Z]+) ([a-zA-Z]+(\.[a-zA-Z]+)+) "([^"]*)" \[Client (\b(?:(?:2(?:[0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9])\.){3}(?:(?:2([0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9]))\b)] \[Length ([0-9]+)] \[Gzip -] \[Sent-to (([0-9+(\.[0-9]+)+)] "([^"]*)" "([^"]*)"', 5, RawData)
| extend HttpStatusCode = extract(@'(\[[^\]]*]) - ([0-9]+) ([0-9]+) - ([a-zA-Z]+) ([a-zA-Z]+) ([a-zA-Z]+(\.[a-zA-Z]+)+) "([^"]*)" \[Client (\b(?:(?:2(?:[0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9])\.){3}(?:(?:2([0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9]))\b)] \[Length ([0-9]+)] \[Gzip -] \[Sent-to (([0-9+(\.[0-9]+)+)] "([^"]*)" "([^"]*)"', 3, RawData)
| extend HttpStatusCodeCache = extract(@'(\[[^\]]*]) - ([0-9]+) ([0-9]+) - ([a-zA-Z]+) ([a-zA-Z]+) ([a-zA-Z]+(\.[a-zA-Z]+)+) "([^"]*)" \[Client (\b(?:(?:2(?:[0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9])\.){3}(?:(?:2([0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9]))\b)] \[Length ([0-9]+)] \[Gzip -] \[Sent-to (([0-9+(\.[0-9]+)+)] "([^"]*)" "([^"]*)"', 2, RawData)
| extend HttpResponseBodyBytes = extract(@'(\[[^\]]*]) - ([0-9]+) ([0-9]+) - ([a-zA-Z]+) ([a-zA-Z]+) ([a-zA-Z]+(\.[a-zA-Z]+)+) "([^"]*)" \[Client (\b(?:(?:2(?:[0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9])\.){3}(?:(?:2([0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9]))\b)] \[Length ([0-9]+)] \[Gzip -] \[Sent-to (([0-9+(\.[0-9]+)+)] "([^"]*)" "([^"]*)"', 11, RawData)
| extend HttpReferrerOriginal = extract(@'(\[[^\]]*]) - ([0-9]+) ([0-9]+) - ([a-zA-Z]+) ([a-zA-Z]+) ([a-zA-Z]+(\.[a-zA-Z]+)+) "([^"]*)" \[Client (\b(?:(?:2(?:[0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9])\.){3}(?:(?:2([0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9]))\b)] \[Length ([0-9]+)] \[Gzip -] \[Sent-to (([0-9+(\.[0-9]+)+)] "([^"]*)" "([^"]*)"', 15, RawData)
| extend HttpUserAgentOriginal = extract(@'(\[[^\]]*]) - ([0-9]+) ([0-9]+) - ([a-zA-Z]+) ([a-zA-Z]+) ([a-zA-Z]+(\.[a-zA-Z]+)+) "([^"]*)" \[Client (\b(?:(?:2(?:[0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9])\.){3}(?:(?:2([0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9]))\b)] \[Length ([0-9]+)] \[Gzip -] \[Sent-to (([0-9+(\.[0-9]+)+)] "([^"]*)" "([^"]*)"', 14, RawData)
};
let nginx_fallbackaccesslog_events =() {
NGINX_CL
| where RawData matches regex @'(\[[^\]]*]) ([0-9]+) - ([a-zA-Z]+|-) ([a-zA-Z]+) (.*) "([^"]*)" \[Client (\b(?:(?:2(?:[0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9])\.){3}(?:(?:2([0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9]))\b)] \[Length ([0-9]+)] \[Gzip .*] "([^"]*)" "([^"]*)"'
| extend EventProduct = 'NGINX Proxy Manager'
| extend EventType = 'AccessLog'
| extend SrcIpAddr = extract(@'(\[[^\]]*]) ([0-9]+) - ([a-zA-Z]+|-) ([a-zA-Z]+) (.*) "([^"]*)" \[Client (\b(?:(?:2(?:[0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9])\.){3}(?:(?:2([0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9]))\b)] \[Length ([0-9]+)] \[Gzip .*] "([^"]*)" "([^"]*)"', 7, RawData)
| extend EventStartTime = todatetime(replace(@'\/', @'-', replace(@'(\d{2}\/\w{3}\/\d{4}):(\d{2}\:\d{2}\:\d{2})', @'\1 \2', extract(@'\[(.*?)\+\d+\]', 1, RawData))))
| extend HttpRequestMethod = extract(@'(\[[^\]]*]) ([0-9]+) - ([a-zA-Z]+|-) ([a-zA-Z]+) (.*) "([^"]*)" \[Client (\b(?:(?:2(?:[0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9])\.){3}(?:(?:2([0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9]))\b)] \[Length ([0-9]+)] \[Gzip .*] "([^"]*)" "([^"]*)"', 3, RawData)
| extend Host = extract(@'(\[[^\]]*]) ([0-9]+) - ([a-zA-Z]+|-) ([a-zA-Z]+) (.*) "([^"]*)" \[Client (\b(?:(?:2(?:[0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9])\.){3}(?:(?:2([0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9]))\b)] \[Length ([0-9]+)] \[Gzip .*] "([^"]*)" "([^"]*)"', 5, RawData)
| extend UrlOriginal = extract(@'(\[[^\]]*]) ([0-9]+) - ([a-zA-Z]+|-) ([a-zA-Z]+) (.*) "([^"]*)" \[Client (\b(?:(?:2(?:[0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9])\.){3}(?:(?:2([0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9]))\b)] \[Length ([0-9]+)] \[Gzip .*] "([^"]*)" "([^"]*)"', 6, RawData)
| extend Scheme = extract(@'(\[[^\]]*]) ([0-9]+) - ([a-zA-Z]+|-) ([a-zA-Z]+) (.*) "([^"]*)" \[Client (\b(?:(?:2(?:[0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9])\.){3}(?:(?:2([0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9]))\b)] \[Length ([0-9]+)] \[Gzip .*] "([^"]*)" "([^"]*)"', 4, RawData)
| extend HttpStatusCode = extract(@'(\[[^\]]*]) ([0-9]+) - ([a-zA-Z]+|-) ([a-zA-Z]+) (.*) "([^"]*)" \[Client (\b(?:(?:2(?:[0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9])\.){3}(?:(?:2([0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9]))\b)] \[Length ([0-9]+)] \[Gzip .*] "([^"]*)" "([^"]*)"', 2, RawData)
| extend HttpResponseBodyBytes = extract(@'(\[[^\]]*]) ([0-9]+) - ([a-zA-Z]+|-) ([a-zA-Z]+) (.*) "([^"]*)" \[Client (\b(?:(?:2(?:[0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9])\.){3}(?:(?:2([0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9]))\b)] \[Length ([0-9]+)] \[Gzip .*] "([^"]*)" "([^"]*)"', 9, RawData)
| extend HttpReferrerOriginal = extract(@'(\[[^\]]*]) ([0-9]+) - ([a-zA-Z]+|-) ([a-zA-Z]+) (.*) "([^"]*)" \[Client (\b(?:(?:2(?:[0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9])\.){3}(?:(?:2([0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9]))\b)] \[Length ([0-9]+)] \[Gzip .*] "([^"]*)" "([^"]*)"', 11, RawData)
| extend HttpUserAgentOriginal = extract(@'(\[[^\]]*]) ([0-9]+) - ([a-zA-Z]+|-) ([a-zA-Z]+) (.*) "([^"]*)" \[Client (\b(?:(?:2(?:[0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9])\.){3}(?:(?:2([0-4][0-9]|5[0-5])|[0-1]?[0-9]?[0-9]))\b)] \[Length ([0-9]+)] \[Gzip .*] "([^"]*)" "([^"]*)"', 10, RawData)
};
let nginx_errorlog_events=() {
NGINX_CL
| where RawData matches regex @'\A\d{4}\/\d{2}\/\d{2}\s+\d{2}\:\d{2}\:\d{2}\s+\[.*?\]\s\d+\#\d+\:'
| extend EventProduct = 'NGINX Proxy Manager'
| extend EventType = 'ErrorLog'
| extend EventType = 'ErrorLog'
| extend EventSeverity = extract(@'\[(.*?)\]', 1, RawData)
| extend EventStartTime = todatetime(replace(@'\/', '-', extract(@'\A(.*?)\s\[', 1, RawData)))
| extend SrcIpAddr = extract(@'client: (\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})', 1, RawData)
| extend ProcessId = extract(@'\]\s(\d+)\#', 1, RawData)
| extend ThreadId = extract(@'\]\s\d+\#(\d+)\:', 1, RawData)
| extend EventMessage = extract(@'\d+\#\d+\:\s(.*)', 1, RawData)
};
union isfuzzy=true nginx_accesslog_events, nginx_fallbackaccesslog_events, nginx_errorlog_events
| project TimeGenerated
        , EventProduct
        , EventType
        , EventSeverity
        , EventStartTime
        , SrcIpAddr
        , HttpRequestMethod
        , Host
        , UrlOriginal
        , Upstream
        , Scheme
        , HttpStatusCode
        , HttpStatusCodeCache
        , HttpResponseBodyBytes
        , HttpReferrerOriginal
        , HttpUserAgentOriginal
        , ProcessId
        , ThreadId
        , EventMessage